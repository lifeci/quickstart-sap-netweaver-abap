---
AWSTemplateFormatVersion: 2010-09-09
Description: Deploy SAP Additional Application Server (qs-1no61sjl2)
Metadata:
  'AWS::CloudFormation::Interface':
    ParameterGroups:
      - Label:
          default: Existing network infrastructure details
        Description:
          default: ''
        Parameters:
          - VPCID
          - PrivateSubnet1CIDR
          - PrivateSubnet2CIDR
          - PublicSubnet1CIDR
          - PublicSubnet2CIDR
          - PrivateSubnetID
      - Label:
          default: Server and storage configuration
        Description:
          default: ''
        Parameters:
          - KeyName
      - Label:
          default: SAP App Server setup and configuration
        Description:
          default: ''
        Parameters:
          - DistributedInstall
          - EFSSapmnt
          - EFSFSName
          - HostedZoneName
          - HostedZoneID
          - SAPASCSHostname
          - SAPPASHostname
          - SAPHANAHostname
          - SAPAASHostname
          - SID
          - SAPSchemaName
          - SAPInstanceNum
          - SIDadmUID
          - SAPTZ
          - SAPNetWeaverPassSSMParamName
          - MyOS
          - SLESBYOSRegCode
          - MyInstanceType
          - AutoRecovery
          - InstallSAP
          - InstallSAPVersion
      - Label:
          default: >-
            Advanced configuration (Do not modify unless directed by AWS
            Support)
        Description:
          default: ''
        Parameters:
          - QSS3BucketName
          - QSS3KeyPrefix
    ParameterLabels:
      AutoRecovery:
        default: EC2 Auto Recovery
      DistributedInstall:
        default: The ASCS and PAS are split(i.e. Distributed installation)
      EFSFSName:
        default: Existing EFS fs name
      EFSSapmnt:
        default: Use EFS for /sapmnt
      HostedZoneName:
        default: Existing R53 private hosted zone name
      InstallSAP:
        default: Install SAP software
      InstallSAPVersion:
        default: SAP NW version
      KeyName:
        default: SSH key pair
      MyInstanceType:
        default: Choose instance type
      MyOS:
        default: O.S. version for SAP Servers (SLES only)
      PrivateSubnetID:
        default: Private Subnet ID
      PrivateSubnet1CIDR:
        default: Private Subnet 1 CIDR
      PrivateSubnet2CIDR:
        default: Private Subnet 2 CIDR
      PublicSubnet1CIDR:
        default: Public Subnet 1 CIDR
      PublicSubnet2CIDR:
        default: Public Subnet 2 CIDR
      QSS3BucketName:
        default: S3 bucket name for the Quick Start assets.
      QSS3KeyPrefix:
        default: S3 key prefix for the Quick Start assets
      SAPASCSHostname:
        default: SAP ASCS Server hostname
      SAPAASHostname:
        default: SAP AAS Server hostname
      SAPHANAHostname:
        default: SAP HANA Server hostname
      SAPInstanceNum:
        default: SAP instance number
      SAPNetWeaverPassSSMParamName:
        default: Existing EC2 SSM parameter store name
      SAPPASHostname:
        default: SAP PAS server hostname
      SAPTZ:
        default: SAP Server timezone
      SAPSchemaName:
        default: SAP database schema
      SID:
        default: SAP system ID
      SIDadmUID:
        default: SIDadm user id
      SLESBYOSRegCode:
        default: Enter SUSE BYOS Registration Code
      VPCID:
        default: Choose VPC ID
Parameters:
  MainCidrBlock:
    Type: String
  KernSar:
    Type: String
    Description: folder with SAR archives (latest)
  AutoRecovery:
    Type: String
    Description: EC2 Automatic recovery feature
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
  DistributedInstall:
    Description: ASCS and PAS are distr. onto 2 different instances
    Default: 'No'
    Type: String
    AllowedValues:
      - 'Yes'
      - 'No'
  EFSSapmnt:
    AllowedValues:
      - 'Yes'
      - 'No'
    Default: 'No'
    Description: Enable (Yes) or disable (No) EFS for /sapmnt.
    Type: String
  EFSFSName:
    Description: An *existing* EFS filesystem name.
    Default: efs-fsname
    Type: String
  HostedZoneID:
    Description: Id. of an *existing* R53 privated hosted zone.
    Type: 'AWS::Route53::HostedZone::Id'
  HostedZoneName:
    Description: >-
      An *existing* R53 privated hosted zone name e.g. mycompany.local. Hint:
      See name in Zone Id.
    Type: String
    MinLength: '1'
    MaxLength: '64'
    AllowedPattern: '(?!-)[a-zA-Z0-9-.]*(?<!-)'
    ConstraintDescription: must be a valid fully-qualified domain name.
  InstallSAP:
    AllowedValues:
      - 'Yes'
      - 'No'
    Default: 'Yes'
    Description: >-
      Install (Yes) or don't install (No) SAP Autoscaling App Servers. When set
      to No, *only* AWS infrastructure is provisioned.
    Type: String
  InstallSAPVersion:
    Type: String
    Description: SAP NW version to install.
    Default: SAP-NetWeaver-7.4
    AllowedValues:
      - SAP-NetWeaver-7.4
      - SAP-NetWeaver-7.5
  KeyName:
    Description: >-
      Name of an existing Amazon EC2 key pair. All instances will launched with
      this key pair.
    Type: 'AWS::EC2::KeyPair::KeyName'
  MyInstanceType:
    AllowedValues:
      - r4.4xlarge
      - r4.2xlarge
      - r4.xlarge
      - r4.large
      - m4.4xlarge
      - m4.2xlarge
      - m4.xlarge
      - m4.large
      - c4.4xlarge
      - c4.2xlarge
      - c4.xlarge
      - c4.large
    Default: r4.xlarge
    Description: Instance type for SAP Servers.
    Type: String
  MyOS:
    AllowedValues:
      - SuSE-Linux-11-SP4-HVM
      - SuSE-Linux-12-SP1-HVM
      - SuSE-Linux-12-SP2-HVM
      - SuSE-Linux-12-SP3-HVM
      - SuSE-Linux-12-SP1-For-SAP-HVM
      - SuSE-Linux-12-SP2-For-SAP-HVM
      - SuSE-Linux-12-SP3-For-SAP-HVM
      - SuSE-Linux-12-SP1-For-SAP-BYOS-HVM
      - SuSE-Linux-12-SP2-For-SAP-BYOS-HVM
      - SuSE-Linux-12-SP3-For-SAP-BYOS-HVM
    Default: SuSE-Linux-12-SP3-HVM
    Description: Operating system (SLES only) version for SAP servers.
    Type: String
  PrivateSubnetID:
    Description: Private subnet to deploy SAP Additional App Server.
    Type: 'AWS::EC2::Subnet::Id'
  PrivateSubnet1CIDR:
    AllowedPattern: >-
      ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.0.0/19
    Description: CIDR block for private subnet 1 located in Availability Zone 1
    Type: String
  PrivateSubnet2CIDR:
    AllowedPattern: >-
      ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.32.0/19
    Description: CIDR block for private subnet 2 located in Availability Zone 2
    Type: String
  PublicSubnet1CIDR:
    AllowedPattern: >-
      ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.128.0/20
    Description: CIDR block for the public (DMZ) subnet 1 located in Availability Zone 1
    Type: String
  PublicSubnet2CIDR:
    AllowedPattern: >-
      ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.144.0/20
    Description: CIDR block for the public (DMZ) subnet 2 located in Availability Zone 2
    Type: String
  QSS3BucketName:
    AllowedPattern: '^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$'
    ConstraintDescription: >-
      Quick Start bucket name can include numbers, lowercase letters, uppercase
      letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Default: aws-quickstart
    Description: >-
      S3 bucket name for the Quick Start assets. This string can include
      numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot
      start or end with a hyphen (-).
    Type: String
  QSS3KeyPrefix:
    AllowedPattern: '^[0-9a-zA-Z-/]*$'
    ConstraintDescription: >-
      Quick Start key prefix can include numbers, lowercase letters, uppercase
      letters, hyphens (-), and forward slash (/).
    Default: quickstart-sap-netweaver-abap/
    Description: >-
      S3 key prefix for the Quick Start assets. Quick Start key prefix can
      include numbers, lowercase letters, uppercase letters, hyphens (-), and
      forward slash (/).
    Type: String
  SAPAASHostname:
    Default: sapaas00
    Description: Host name to use for SAP AAS Server.
    Type: String
  SAPHANAHostname:
    Default: saphanaqs
    Description: >-
      Host name to use for SAP HANA database (SAP App server must be able to
      access HANA server).
    Type: String
  SAPInstanceNum:
    AllowedPattern: '([0-8]{1}[0-9]{1}|[9]{1}[0-7]{1})'
    Default: '00'
    Description: >-
      SAP instance number to use for installation and setup, and to open ports
      for security groups.
    Type: String
  SAPNetWeaverPassSSMParamName:
    AllowedPattern: ^(?!ssm).*$
    ConstraintDescription: Name of *existing* SSM  parameter store can *not* begin with ssm.
    Description: >-
      Name of *existing* EC2 SSM  parameter store. The encrypted master password
      is stored in the SSM parameter store
    MinLength: '1'
    NoEcho: 'false'
    Type: String
  SAPASCSHostname:
    Default: sapasc00
    Description: Existing SAP ASCS server's hostname.
    Type: String
  SAPPASHostname:
    Default: sappas00
    Description: >-
      Host name to use for SAP PAS Server (DNS short name). Can be the same as
      the ASCS server
    Type: String
  SAPTZ:
    AllowedValues:
      - PT
      - CT
      - ET
      - UC
    ConstraintDescription: This value must consist of 2 characters.
    Default: UC
    Description: 'The TimeZone of your SAP Server (PT, CT, ET, or UTC)'
    Type: String
  SAPSchemaName:
    Default: SAPABAP1
    Description: SAP ABAP Schema name for HANA database .
    Type: String
  SID:
    AllowedPattern: '([A-Z]{1}[0-9A-Z]{2})'
    ConstraintDescription: This value must consist of 3 characters.
    Default: HDB
    Description: SAP system ID for installation and setup.
    Type: String
  SIDadmUID:
    Default: '1002'
    Description: UID (default is 1002) for the SIDadm user.
    Type: String
  SLESBYOSRegCode:
    Type: String
    Default: ''
    Description: Registration code for SUSE BYOS (Applicable only if you use BYOS Option).
  VPCID:
    Description: The existing Amazon VPC where you want to deploy SAP App Server Cluster.
    Type: 'AWS::EC2::VPC::Id'
Conditions:
  AutoRecoveryMaster: !Equals
    - !Ref AutoRecovery
    - 'Yes'
Mappings:
  SAPHANAOSNameMap:
    Red-Hat-Enterprise-Linux-7.3-For-SAP-HVM:
      Code: RedHatLinux73ForSAP
    SuSE-Linux-11-SP4-HVM:
      Code: SuSELinux11SP4
    SuSE-Linux-12-SP1-HVM:
      Code: SuSELinux12SP1
    SuSE-Linux-12-SP2-HVM:
      Code: SuSELinux12SP2
    SuSE-Linux-12-SP3-HVM:
      Code: SuSELinux12SP3
    SuSE-Linux-12-SP1-For-SAP-HVM:
      Code: SuSELinux12SP1ForSAP
    SuSE-Linux-12-SP2-For-SAP-HVM:
      Code: SuSELinux12SP2ForSAP
    SuSE-Linux-12-SP3-For-SAP-HVM:
      Code: SuSELinux12SP3ForSAP
    SuSE-Linux-12-SP1-For-SAP-BYOS-HVM:
      Code: SuSELinux12SP1ForSAP-BYOS
    SuSE-Linux-12-SP2-For-SAP-BYOS-HVM:
      Code: SuSELinux12SP2ForSAP-BYOS
    SuSE-Linux-12-SP3-For-SAP-BYOS-HVM:
      Code: SuSELinux12SP3ForSAP-BYOS
  SAPAMINameMap:
    RedHatLinux73ForSAP:
      Code: RHEL73SAPHVM
    SuSE-Linux-11-SP4-HVM:
      Code: SLES11SP4HVM
    SuSE-Linux-12-HVM:
      Code: SLES12HVM
    SuSE-Linux-12-SP1-HVM:
      Code: SLES12SP1HVM
    SuSE-Linux-12-SP2-HVM:
      Code: SLES12SP2HVM
    SuSE-Linux-12-SP3-HVM:
      Code: SLES12SP3HVM
    SuSE-Linux-12-SP1-For-SAP-HVM:
      Code: SLES12SP1SAPHVM
    SuSE-Linux-12-SP2-For-SAP-HVM:
      Code: SLES12SP2SAPHVM
    SuSE-Linux-12-SP3-For-SAP-HVM:
      Code: SLES12SP3SAPHVM
    SuSE-Linux-12-SP1-For-SAP-BYOS-HVM:
      Code: SLES12SP1SAPBYOSHVM
    SuSE-Linux-12-SP2-For-SAP-BYOS-HVM:
      Code: SLES12SP2SAPBYOSHVM
    SuSE-Linux-12-SP3-For-SAP-BYOS-HVM:
      Code: SLES12SP3SAPBYOSHVM
  AWSAMIRegionMap:
    AMI:
      RHEL73SAPHVM: >-
        SAP-7.3_HVM-20180116-x86_64-1-Hourly2-GP2-b676039c-a4f8-4be7-9866-c804b1ade684-ami-d4ffddae.4
      SLES11SP4HVM: suse-sles-11-sp4-v20180816-hvm-ssd-x86_64
      SLES12SP1HVM: suse-sles-12-sp1-v20161021-hvm-ssd-x86_64
      SLES12SP2HVM: suse-sles-12-sp2-v20170620-hvm-ssd-x86_64
      SLES12SP3HVM: suse-sles-12-sp3-v20181004-hvm-ssd-x86_64
      SLES12SP1SAPHVM: >-
        suse-sles-sap-12-sp1-v20171121-hvm-ssd-x86_64-f0188081-b780-4ee4-aef6-cbcb063fd11e-ami-8bac24f1.4
      SLES12SP2SAPHVM: >-
        suse-sles-sap-12-sp2-v20180706-hvm-ssd-x86_64-e3458d64-5c36-4577-bd98-0ee19e3eaeec-ami-3ac5ea45.4
      SLES12SP3SAPHVM: >-
        suse-sles-sap-12-sp3-v20180814-hvm-ssd-x86_64-da7aa9c3-97db-4573-89a6-7fe7348d90b0-ami-0df5b06332b816a8e.4
      SLES12SP1SAPBYOSHVM: suse-sles-sap-12-sp1-byos-v20170123-hvm-ssd-x86_64
      SLES12SP2SAPBYOSHVM: suse-sles-sap-12-sp2-byos-v20180816-hvm-ssd-x86_64
      SLES12SP3SAPBYOSHVM: suse-sles-sap-12-sp3-byos-v20180814-hvm-ssd-x86_64
      WS2012R2: Windows_Server-2012-R2_RTM-English-64Bit-Base-2018.11.19
    ap-northeast-1:
      RHEL73SAPHVM: ami-e5036283
      SLES11SP4HVM: ami-0c6f393bb8d20159a
      SLES12SP1HVM: ami-d94fe9b8
      SLES12SP1SAPBYOSHVM: ami-63473c04
      SLES12SP1SAPHVM: ami-a6da67c0
      SLES12SP2HVM: ami-a07560c7
      SLES12SP2SAPBYOSHVM: ami-0fcd0e48bd60c9ee6
      SLES12SP2SAPHVM: ami-322e43df
      SLES12SP3HVM: ami-050f5170e43607893
      SLES12SP3SAPBYOSHVM: ami-0b0ded1fd5d53c9e9
      SLES12SP3SAPHVM: ami-05e66d665f69082c4
      WS2012R2: ami-0f85dbebb332bfe92
    ap-northeast-2:
      RHEL73SAPHVM: ami-e0e5468e
      SLES11SP4HVM: ami-00e7068674ce94853
      SLES12SP1HVM: ami-1ced3972
      SLES12SP1SAPBYOSHVM: ami-b5f928db
      SLES12SP1SAPHVM: ami-5f993e31
      SLES12SP2HVM: ami-86d00fe8
      SLES12SP2SAPBYOSHVM: ami-07c176c4af92973f6
      SLES12SP2SAPHVM: ami-241fab4a
      SLES12SP3HVM: ami-00728f974fb4b3f2a
      SLES12SP3SAPBYOSHVM: ami-09a3d6b40137b0c62
      SLES12SP3SAPHVM: ami-071d0cc87c99d6fca
      WS2012R2: ami-0a38649dfe79e9c37
    ap-south-1:
      RHEL73SAPHVM: ami-f383d59c
      SLES11SP4HVM: ami-0bdb8670f707feabd
      SLES12SP1HVM: ami-985226f7
      SLES12SP1SAPBYOSHVM: ami-93c9bffc
      SLES12SP1SAPHVM: ami-b3e6a9dc
      SLES12SP2HVM: ami-62e39c0d
      SLES12SP2SAPBYOSHVM: ami-04e3253865938cd82
      SLES12SP2SAPHVM: ami-c9d0e1a6
      SLES12SP3HVM: ami-0c1453eb750c7a5ab
      SLES12SP3SAPBYOSHVM: ami-08f3e25abb82c7b6b
      SLES12SP3SAPHVM: ami-0786e9ea7350f5931
      WS2012R2: ami-0fa931e70104cf960
    ap-southeast-1:
      RHEL73SAPHVM: ami-92ef90ee
      SLES11SP4HVM: ami-021e49892145e1949
      SLES12SP1HVM: ami-163d9b75
      SLES12SP1SAPBYOSHVM: ami-ab0aa0c8
      SLES12SP1SAPHVM: ami-65a7f006
      SLES12SP2HVM: ami-f1078a92
      SLES12SP2SAPBYOSHVM: ami-0ae95671afac01725
      SLES12SP2SAPHVM: ami-d558203f
      SLES12SP3HVM: ami-06190570cf455031a
      SLES12SP3SAPBYOSHVM: ami-059895770fc7c71d6
      SLES12SP3SAPHVM: ami-0a03524280ada8595
      WS2012R2: ami-0845140e3742219fd
    ap-southeast-2:
      RHEL73SAPHVM: ami-f6d62994
      SLES11SP4HVM: ami-0c966540b7cd84b4b
      SLES12SP1HVM: ami-e32b1680
      SLES12SP1SAPBYOSHVM: ami-460d0a25
      SLES12SP1SAPHVM: ami-9abe54f8
      SLES12SP2HVM: ami-197a6a7a
      SLES12SP2SAPBYOSHVM: ami-0a46a8634f9cf4773
      SLES12SP2SAPHVM: ami-ad41e4cf
      SLES12SP3HVM: ami-0ccbc8eb74e84b8bd
      SLES12SP3SAPBYOSHVM: ami-0249d633f929faf81
      SLES12SP3SAPHVM: ami-0cb175ddfd285fd68
      WS2012R2: ami-0ab7f92d82234c436
    ca-central-1:
      RHEL73SAPHVM: ami-2a63e64e
      SLES11SP4HVM: ami-0a89186e8d2b82307
      SLES12SP1SAPBYOSHVM: ami-2fd4694b
      SLES12SP1SAPHVM: ami-368a3152
      SLES12SP2HVM: ami-d5d56ab1
      SLES12SP2SAPBYOSHVM: ami-0939c0572f1ad4cd7
      SLES12SP2SAPHVM: ami-23ca4747
      SLES12SP3HVM: ami-0f7c9a39e20a9adea
      SLES12SP3SAPBYOSHVM: ami-0b480fe4a1992dfcb
      SLES12SP3SAPHVM: ami-3d3db059
      WS2012R2: ami-0678d1d3beb8edf0e
    eu-central-1:
      RHEL73SAPHVM: ami-d866f9b7
      SLES11SP4HVM: ami-0f032693ef4319469
      SLES12SP1HVM: ami-59699036
      SLES12SP1SAPBYOSHVM: ami-4b6ba424
      SLES12SP1SAPHVM: ami-7efc7e11
      SLES12SP2HVM: ami-984ee9f7
      SLES12SP2SAPBYOSHVM: ami-0a4b6a1303d820d52
      SLES12SP2SAPHVM: ami-2a6463c1
      SLES12SP3HVM: ami-0fa9bde3f3d40e5ae
      SLES12SP3SAPBYOSHVM: ami-035997e605600f24d
      SLES12SP3SAPHVM: ami-01517077c8ef929c7
      WS2012R2: ami-0c719be417bc6a3f6
    eu-west-1:
      RHEL73SAPHVM: ami-e365fd9a
      SLES11SP4HVM: ami-0a40ff0e3202c10e1
      SLES12SP1HVM: ami-b197d9c2
      SLES12SP1SAPBYOSHVM: ami-81025de7
      SLES12SP1SAPHVM: ami-03ef587a
      SLES12SP2HVM: ami-f5776f93
      SLES12SP2SAPBYOSHVM: ami-048e8991161e07ba8
      SLES12SP2SAPHVM: ami-fa0c1e10
      SLES12SP3HVM: ami-06bc7889ee68f279e
      SLES12SP3SAPBYOSHVM: ami-0dc906e72df071f00
      SLES12SP3SAPHVM: ami-0dd261bbc18ff512a
      WS2012R2: ami-0a5e0d1ffedf82238
    eu-west-2:
      RHEL73SAPHVM: ami-03fee567
      SLES11SP4HVM: ami-06a87787f9466fa7b
      SLES12SP1SAPBYOSHVM: ami-b2a1abd6
      SLES12SP1SAPHVM: ami-ebc3dc8f
      SLES12SP2HVM: ami-d97066bd
      SLES12SP2SAPBYOSHVM: ami-02ae5e7d40383aa35
      SLES12SP2SAPHVM: ami-2992794e
      SLES12SP3HVM: ami-0eb4bd78fba2f32e4
      SLES12SP3SAPBYOSHVM: ami-0511a35ec641e8d42
      SLES12SP3SAPHVM: ami-007f4f140fb79e469
      WS2012R2: ami-0ca1b0ae0ac576ff9
    eu-west-3:
      RHEL73SAPHVM: ami-7ae85e07
      SLES11SP4HVM: ami-036671c4b09355867
      SLES12SP1SAPBYOSHVM: ami-cf992eb2
      SLES12SP1SAPHVM: ami-41893e3c
      SLES12SP2SAPBYOSHVM: ami-0a91a227920c1c660
      SLES12SP2SAPHVM: ami-bfbf0fc2
      SLES12SP3HVM: ami-07b20332d54ed21e8
      SLES12SP3SAPBYOSHVM: ami-02aade11c6173a417
      SLES12SP3SAPHVM: ami-0f7cb07e8a64837da
      WS2012R2: ami-0ddec2a39006ff201
    sa-east-1:
      RHEL73SAPHVM: ami-0b8ac767
      SLES11SP4HVM: ami-00134f83806a20f4a
      SLES12SP1HVM: ami-ce3aa7a2
      SLES12SP1SAPBYOSHVM: ami-eb543187
      SLES12SP1SAPHVM: ami-798cc915
      SLES12SP2HVM: ami-52a4cf3e
      SLES12SP2SAPBYOSHVM: ami-0f3b06f3008cb71a3
      SLES12SP2SAPHVM: ami-5cd5f230
      SLES12SP3HVM: ami-0188b2a9dc0ae5f44
      SLES12SP3SAPBYOSHVM: ami-04dacddc0bed7ea0c
      SLES12SP3SAPHVM: ami-0bce441632c6a4f49
      WS2012R2: ami-0b3ca659f290c9004
    us-east-1:
      RHEL73SAPHVM: ami-39f0de43
      SLES11SP4HVM: ami-05b47745292b62b8e
      SLES12SP1HVM: ami-1eeab909
      SLES12SP1SAPBYOSHVM: ami-7dd2256b
      SLES12SP1SAPHVM: ami-f20f8788
      SLES12SP2HVM: ami-8fac8399
      SLES12SP2SAPBYOSHVM: ami-0badcc32d038e76b6
      SLES12SP2SAPHVM: ami-1c477763
      SLES12SP3HVM: ami-03adb8813ffd80f0b
      SLES12SP3SAPBYOSHVM: ami-0a716f006d0e61fda
      SLES12SP3SAPHVM: ami-0670bf4d2d9a6151b
      WS2012R2: ami-0f7af6e605e2d2db5
    us-east-2:
      RHEL73SAPHVM: ami-bbe4cede
      SLES11SP4HVM: ami-0d984fc673fefcb8c
      SLES12SP1HVM: ami-85075de0
      SLES12SP1SAPBYOSHVM: ami-ac2401c9
      SLES12SP1SAPHVM: ami-3df7d958
      SLES12SP2HVM: ami-f990b69c
      SLES12SP2SAPBYOSHVM: ami-044b76b9b1d1910cb
      SLES12SP2SAPHVM: ami-e10c3784
      SLES12SP3HVM: ami-0479b39f2d07530fb
      SLES12SP3SAPBYOSHVM: ami-0ce850e2837a005b7
      SLES12SP3SAPHVM: ami-046343b8758067d02
      WS2012R2: ami-032a2c09fc31731e9
    us-west-1:
      RHEL73SAPHVM: ami-0be4e66b
      SLES11SP4HVM: ami-07db9616cb48eef6e
      SLES12SP1HVM: ami-a12962c1
      SLES12SP1SAPBYOSHVM: ami-4a9dcf2a
      SLES12SP1SAPHVM: ami-5ce8d03c
      SLES12SP2HVM: ami-32c8e552
      SLES12SP2SAPBYOSHVM: ami-0e0cae02fda577d62
      SLES12SP2SAPHVM: ami-5f64873c
      SLES12SP3HVM: ami-05561250b8346a707
      SLES12SP3SAPBYOSHVM: ami-07e600a32a750ad05
      SLES12SP3SAPHVM: ami-08c9d05a34bc4f225
      WS2012R2: ami-035292aa3f696bc09
    us-west-2:
      RHEL73SAPHVM: ami-edfa4895
      SLES11SP4HVM: ami-09a652af9ed1e0dad
      SLES12SP1HVM: ami-7fa2061f
      SLES12SP1SAPBYOSHVM: ami-68922c08
      SLES12SP1SAPHVM: ami-94fb26ec
      SLES12SP2HVM: ami-da786da3
      SLES12SP2SAPBYOSHVM: ami-0daf2aa65f54dfc6b
      SLES12SP2SAPHVM: ami-7bb5e603
      SLES12SP3HVM: ami-015ee9a0398544b09
      SLES12SP3SAPBYOSHVM: ami-0da29a8e3dc64a63f
      SLES12SP3SAPHVM: ami-b73516cf
      WS2012R2: ami-0eade913a026daf38
Outputs:
  SAPPASSecurityGroup:
    Description: Security Group created for the SAP PAS Server
    Value: !GetAtt
      - SAPAASSecurityGroup
      - GroupId
Resources:
  AutoRecoverAlarmMaster:
    Type: 'AWS::CloudWatch::Alarm'
    Condition: AutoRecoveryMaster
    Properties:
      AlarmDescription: >-
        Trigger a recovery when instance status check fails for 2 consecutive
        minutes  .
      Namespace: AWS/EC2
      MetricName: StatusCheckFailed_System
      Statistic: Minimum
      Period: '60'
      EvaluationPeriods: '2'
      ComparisonOperator: GreaterThanThreshold
      Threshold: '0'
      AlarmActions:
        - !Join
          - ''
          - - 'arn:aws:automate:'
            - !Ref 'AWS::Region'
            - ':ec2:recover'
      Dimensions:
        - Name: InstanceId
          Value: !Ref SAPAASInstance
  SAPAASR53Record:
    Type: 'AWS::Route53::RecordSet'
    Properties:
      HostedZoneId: !Ref HostedZoneID
      Name: !Sub '${SAPAASHostname}.${HostedZoneName}'
      Type: A
      TTL: '30'
      ResourceRecords:
        - !GetAtt
          - SAPAASInstance
          - PrivateIp
  SAPAASSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Enable access to the SAP Servers.
      VpcId: !Ref VPCID
      SecurityGroupIngress:
        #RJ-debug temporary: open port for Narotham during AAS 00 installation
        - Description: 'based on ID it have to be 3600, but opening 3601'
          IpProtocol: tcp
          CidrIp: !Ref MainCidrBlock
          FromPort: '3601'
          ToPort: '3601'

        - Description: 'based on ID it have to be 3900, but opening 3901'
          IpProtocol: tcp
          CidrIp: !Ref MainCidrBlock
          FromPort: '3901'
          ToPort: '3901'

        #RJ-debug# Allow connection for sapinst web gui
        - Description: 'RJ-debug: sapinst web gui NW'
          IpProtocol: tcp
          CidrIp: !Ref MainCidrBlock
          FromPort: '4237'
          ToPort: '4237'

        - IpProtocol: udp
          CidrIp: !Ref PrivateSubnet1CIDR
          FromPort: 111
          ToPort: 111
        - IpProtocol: udp
          CidrIp: !Ref PrivateSubnet1CIDR
          FromPort: 2049
          ToPort: 2049
        - IpProtocol: icmp
          CidrIp: !Ref PrivateSubnet1CIDR
          FromPort: "-1"
          ToPort: "-1"
        - IpProtocol: tcp
          CidrIp: !Ref PrivateSubnet1CIDR
          FromPort: !Join
            - ''
            - - '32'
              - !Ref SAPInstanceNum
              - ''
          ToPort: !Join
            - ''
            - - '33'
              - !Ref SAPInstanceNum
              - ''
        - IpProtocol: tcp
          CidrIp: !Ref PrivateSubnet1CIDR
          FromPort: !Join
            - ''
            - - '36'
              - !Ref SAPInstanceNum
              - ''
          ToPort: !Join
            - ''
            - - '36'
              - !Ref SAPInstanceNum
              - ''
        - IpProtocol: tcp
          CidrIp: !Ref PrivateSubnet1CIDR
          FromPort: 1128
          ToPort: 1128
        - IpProtocol: tcp
          CidrIp: !Ref PrivateSubnet1CIDR
          FromPort: 1129
          ToPort: 1129
        - IpProtocol: udp
          CidrIp: !Ref PrivateSubnet2CIDR
          FromPort: 111
          ToPort: 111
        - IpProtocol: udp
          CidrIp: !Ref PrivateSubnet2CIDR
          FromPort: 2049
          ToPort: 2049
        - IpProtocol: icmp
          CidrIp: !Ref PrivateSubnet2CIDR
          FromPort: "-1"
          ToPort: "-1"
        - IpProtocol: tcp
          CidrIp: !Ref PrivateSubnet2CIDR
          FromPort: !Join
            - ''
            - - '32'
              - !Ref SAPInstanceNum
              - ''
          ToPort: !Join
            - ''
            - - '33'
              - !Ref SAPInstanceNum
              - ''
        - IpProtocol: tcp
          CidrIp: !Ref PrivateSubnet2CIDR
          FromPort: !Join
            - ''
            - - '36'
              - !Ref SAPInstanceNum
              - ''
          ToPort: !Join
            - ''
            - - '36'
              - !Ref SAPInstanceNum
              - ''
        - IpProtocol: tcp
          CidrIp: !Ref PrivateSubnet2CIDR
          FromPort: 1128
          ToPort: 1128
        - IpProtocol: tcp
          CidrIp: !Ref PrivateSubnet2CIDR
          FromPort: 1129
          ToPort: 1129
        - IpProtocol: tcp
          CidrIp: !Ref PrivateSubnet2CIDR
          FromPort: 22
          ToPort: 22
        - IpProtocol: tcp
          CidrIp: !Ref PrivateSubnet2CIDR
          FromPort: 22
          ToPort: 22
        - IpProtocol: tcp
          CidrIp: !Ref PublicSubnet1CIDR
          FromPort: 22
          ToPort: 22
        - IpProtocol: tcp
          CidrIp: !Ref PublicSubnet2CIDR
          FromPort: 22
          ToPort: 22
      SecurityGroupEgress:
        - IpProtocol: "-1"
          CidrIp: 0.0.0.0/0
          FromPort: 1
          ToPort: 65535
  SAPAASIAMRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - 'sts:AssumeRole'
      Path: /
      Policies:
        - PolicyName: SAP-AAS-Autoscaling
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action: 'cloudwatch:GetMetricStatistics'
                Resource: '*'
              - Effect: Allow
                Action:
                  - 's3:GetObject'
                Resource:
                  - !Sub 'arn:aws:s3:::${QSS3BucketName}/${QSS3KeyPrefix}*'
                  - !Sub 'arn:aws:s3:::aws-data-provider/*'
              - Effect: Allow
                Action:
                  - 'ec2:DescribeInstances'
                  - 'ec2:DescribeVolumes'
                Resource: '*'
              - Effect: Allow
                Action:
                  - 'ec2messages:*'
                Resource: '*'
              - Effect: Allow
                Action: 'ssm:*'
                Resource: !Sub >-
                  arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${SAPNetWeaverPassSSMParamName}
              - Effect: Allow
                Action: 'ssm:ListCommandInvocations'
                Resource: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:*'
              - Effect: Allow
                Action: 'ssm:*'
                Resource:
                  - !Sub 'arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:instance/*'
                  - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:instance/*'
                  - !Sub 'arn:aws:ssm:${AWS::Region}::document/AWS-RunShellScript'
  SAPAASInterface:
    Type: 'AWS::EC2::NetworkInterface'
    Properties:
      Description: Network Interface for SAP AAS server
      SubnetId: !Ref PrivateSubnetID
      GroupSet:
        - !Ref SAPAASSecurityGroup
      SourceDestCheck: 'true'
      Tags:
        - Key: Network
          Value: Private
  SAPIAMProfile:
    Type: 'AWS::IAM::InstanceProfile'
    Properties:
      Path: /
      Roles:
        - !Ref SAPAASIAMRole
  WaitForSAPInstall:
    Type: 'AWS::CloudFormation::WaitCondition'
    Properties:
      Handle: !Ref WaitForSAPInstallWaitHandle
      Timeout: '14400'
  WaitForSAPInstallWaitHandle:
    Type: 'AWS::CloudFormation::WaitConditionHandle'
    Properties: {}
  SAPAASInstance:
    Type: 'AWS::EC2::Instance'
    Metadata:
      'AWS::CloudFormation::Authentication':
        S3AccessCreds:
          type: S3
          roleName: !Ref SAPAASIAMRole
          buckets:
            - !Ref QSS3BucketName
      'AWS::CloudFormation::Init':
        config:
          files:
            /root/install/config.sh:
              content: !Join
                - ''
                - - export ASCS_NAME=
                  - !Ref SAPASCSHostname
                  - |+

                  - export DistributedInstall=
                  - !Ref DistributedInstall
                  - |+

                  - export EFS=
                  - !Ref EFSSapmnt
                  - |+

                  - export EFS_MT=
                  - !Ref EFSFSName
                  - |+

                  - export HOSTED_ZONE=
                  - !Ref HostedZoneName
                  - |+

                  - export INSTALL_SAP=
                  - !Ref InstallSAP
                  - |+

                  - export INSTALL_SAP_VERSION=
                  - !Ref InstallSAPVersion
                  - |+

                  - export SAP_SCHEMA_NAME=
                  - !Ref SAPSchemaName
                  - |+

                  - export SAP_SID=
                  - !Ref SID
                  - |+

                  - export SSM_PARAM_STORE=
                  - !Ref SAPNetWeaverPassSSMParamName
                  - |+

                  - export TZ_INPUT_PARAM=
                  - !Ref SAPTZ
                  - |+

                  - export DBHOSTNAME=
                  - !Ref SAPHANAHostname
                  - |+

                  - export INSTALL_SAP=
                  - !Ref InstallSAP
                  - |+

                  - export MyOS=
                  - !Ref MyOS
                  - |+

                  - export SLESBYOSRegCode=
                  - !Ref SLESBYOSRegCode
                  - |+

                  - export HOSTNAME=
                  - !Ref SAPAASHostname
                  - |+

                  - export SAPInstanceNum=
                  - !Ref SAPInstanceNum
                  - |+

                  - export SAP_PAS=
                  - !Ref SAPPASHostname
                  - |+

                  - export WaitForSAPInstallWaitHandle=
                  - '"'
                  - !Ref WaitForSAPInstallWaitHandle
                  - '"'
                  - |+

                  - export SIDadmUID=
                  - !Ref SIDadmUID
                  - |+

                  - export REGION=
                  - !Ref 'AWS::Region'
                  - |+

                  - export KERN_SAR=
                  - !Ref KernSar
                  - |+

              mode: '000400'
              owner: root
              group: root
            /root/install/APPX_D00_Linux_HDB.params:
              source: !Sub >-
                https://${QSS3BucketName}.s3.amazonaws.com/${QSS3KeyPrefix}scripts/APPX_D00_Linux_HDB.params
              mode: '000500'
              owner: root
              group: root
              authentication: S3AccessCreds
            /root/install/ASCS_00_Linux_HDB.params:
              source: !Sub >-
                https://${QSS3BucketName}.s3.amazonaws.com/${QSS3KeyPrefix}scripts/ASCS_00_Linux_HDB.params
              mode: '000500'
              owner: root
              group: root
              authentication: S3AccessCreds
            /root/install/DB_00_Linux_HDB.params:
              source: !Sub >-
                https://${QSS3BucketName}.s3.amazonaws.com/${QSS3KeyPrefix}scripts/DB_00_Linux_HDB.params
              mode: '000500'
              owner: root
              group: root
              authentication: S3AccessCreds
            /root/install/PASX_D00_Linux_HDB.params:
              source: !Sub >-
                https://${QSS3BucketName}.s3.amazonaws.com/${QSS3KeyPrefix}scripts/PASX_D00_Linux_HDB.params
              mode: '000500'
              owner: root
              group: root
              authentication: S3AccessCreds
            /root/install/NW75/ASCS_00_Linux_HDB.params:
              source: !Sub >-
                https://${QSS3BucketName}.s3.amazonaws.com/${QSS3KeyPrefix}scripts/NW75/ASCS_00_Linux_HDB.params
              mode: '000500'
              owner: root
              group: root
              authentication: S3AccessCreds
            /root/install/NW75/DB_00_Linux_HDB.params:
              source: !Sub >-
                https://${QSS3BucketName}.s3.amazonaws.com/${QSS3KeyPrefix}scripts/NW75/DB_00_Linux_HDB.params
              mode: '000500'
              owner: root
              group: root
              authentication: S3AccessCreds
            /root/install/NW75/PASX_D00_Linux_HDB.params:
              source: !Sub >-
                https://${QSS3BucketName}.s3.amazonaws.com/${QSS3KeyPrefix}scripts/NW75/PASX_D00_Linux_HDB.params
              mode: '000500'
              owner: root
              group: root
              authentication: S3AccessCreds
            /root/install/NW75/APPX_D00_Linux_HDB.params:
              source: !Sub >-
                https://${QSS3BucketName}.s3.amazonaws.com/${QSS3KeyPrefix}scripts/NW75/APPX_D00_Linux_HDB.params
              mode: '000500'
              owner: root
              group: root
              authentication: S3AccessCreds
            /root/install/signalFinalStatus.sh:
              source: !Sub >-
                https://${QSS3BucketName}.s3.amazonaws.com/${QSS3KeyPrefix}scripts/signalFinalStatus.sh
              mode: '000500'
              owner: root
              group: root
              authentication: S3AccessCreds
            /root/install/sap-app-aas-install-dnl.sh:
              source: !Sub >-
                https://${QSS3BucketName}.s3.amazonaws.com/${QSS3KeyPrefix}scripts/sap-app-aas-install-dnl.sh
              mode: '000500'
              owner: root
              group: root
              authentication: S3AccessCreds
            /root/install/sap-app-aas-install.sh:
              source: !Sub >-
                https://${QSS3BucketName}.s3.amazonaws.com/${QSS3KeyPrefix}scripts/sap-app-aas-install.sh
              mode: '000500'
              owner: root
              group: root
              authentication: S3AccessCreds
          commands:
            startinstall:
              command: bash -xv /root/install/sap-app-aas-install-dnl.sh
    Properties:
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            DeleteOnTermination: 'True'
            VolumeSize: '50'
            VolumeType: gp2
        - DeviceName: /dev/xvdb
          Ebs:
            DeleteOnTermination: 'True'
            VolumeSize: '50'
            VolumeType: gp2
        - DeviceName: /dev/xvdc
          Ebs:
            DeleteOnTermination: 'True'
            VolumeSize: '50'
            VolumeType: gp2
      InstanceType: !Ref MyInstanceType
      KeyName: !Ref KeyName
      ImageId: !FindInMap
        - AWSAMIRegionMap
        - !Ref 'AWS::Region'
        - !FindInMap
          - SAPAMINameMap
          - !Ref MyOS
          - Code
      IamInstanceProfile: !Ref SAPIAMProfile
      NetworkInterfaces:
        - NetworkInterfaceId: !Ref SAPAASInterface
          DeviceIndex: '0'
      Tags:
        - Key: Name
          Value: !Ref SAPAASHostname
      UserData: !Base64
        'Fn::Join':
          - ''
          - - |
              #!/bin/bash
            - |
              mkdir -p /root/install
            - 'hostname '
            - !Ref SAPAASHostname
            - |+

            - 'echo '
            - !Join
              - .
              - - !Ref SAPAASHostname
            - |2
               > /etc/HOSTNAME
            - |
              export PATH=$PATH:/usr/local/bin
            - |2
                     cd /tmp
            - |2
                     wget https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz
            - |2
                     gzip -df aws-cfn-bootstrap-latest.tar.gz
            - |2
                     tar -xvf aws-cfn-bootstrap-latest.tar
            - |2
                     #ln -s /tmp/aws-cfn-bootstrap-1.4 /opt/aws
            - |2
                     chmod -R 755 /tmp/aws-cfn-bootstrap-1.4
            - |2
                     which pip &> /dev/null
            - |2
                     if [ $? -ne 0 ] ;then
            - |2
                         echo "PIP NOT INSTALLED"
            - |2
                         [ `which yum` ] && $(yum install -y epel-release; yum install -y python-pip) && echo "PIP INSTALLED"
            - |2
                         [ `which apt-get` ] && apt-get -y update && apt-get -y install python-pip && echo "PIP INSTALLED"
            - |2
                         [ `which zypper` ] && zypper -n install python-pip && echo "PIP INSTALLED"
            - |2
                     fi
            - |2
                     pip install --upgrade pip
            - |2
                     pip install --upgrade setuptools
            - |2
                     pip install awscli --ignore-installed six &> /dev/null
            - |2
                     export PYTHONPATH=/tmp/aws-cfn-bootstrap-1.4:$PYTHONPATH
            - '       /tmp/aws-cfn-bootstrap-1.4/bin/cfn-init -v '
            - '         --stack '
            - !Ref 'AWS::StackName'
            - '         --resource SAPAASInstance '
            - '         --region '
            - !Ref 'AWS::Region'
            - |+

Rules:
  EFSSupport:
    RuleCondition: !Equals
      - !Ref EFSSapmnt
      - 'Yes'
    Assertions:
      - Assert:
          'Fn::Contains':
            - - us-east-1
              - us-east-2
              - us-west-1
              - us-west-2
              - eu-west-1
              - eu-central-1
              - ap-southeast-2
            - !Ref 'AWS::Region'
        AssertDescription: '!!ALERT: This is *not* an AWS Region that supports EFS!!'
